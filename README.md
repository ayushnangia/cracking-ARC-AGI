# Neural Cellular Automata for ARC-AGI

This repository explores the application of Neural Cellular Automata (NCAs) to the Abstract Reasoning Corpus (ARC-AGI) challenge. It includes various vanilla NCA implementations and scripts for training, prediction, and evaluation.

For a detailed explanation of the NCA approach and experimental results, please see the [NCAs folder README](./NCAs/README.md).

## Setup

Follow these steps to set up the project environment:

1.  **Clone the repository (if you haven't already):**
    ```bash
    git clone <repository_url>
    cd cracking-ARC-AGI
    ```

2.  **Create and activate a Python virtual environment:**
    It's highly recommended to use a virtual environment to manage dependencies.
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```
    (On Windows, use `venv\Scripts\activate`)

3.  **Install dependencies:**
    The required Python packages are listed in `requirements.txt`. Install them using:
    ```bash
    pip install -r requirements.txt
    ```
    Alternatively, if you have `uv` installed and prefer to use it:
    ```bash
    uv pip install -r requirements.txt
    ```

## Running NCA Experiments

The primary script for running NCA experiments is `NCAs/vanilla-v1/gpu_prl_nca.py`. This script trains a separate NCA model for each task found in the input JSON file and uses multiprocessing to parallelize the process across available CPU cores or GPUs (CUDA/MPS).

1.  **Navigate to the script directory:**
    ```bash
    cd NCAs/vanilla-v1/
    ```

2.  **Run the script:**
    ```bash
    python3 gpu_prl_nca.py
    ```

3.  **Inputs:**
    *   By default, the script uses `dataset/script-tests/grouped-tasks/challenges.json` as the input file containing the ARC tasks. You can modify the `ARC_DATA_DIR` and `INPUT_JSON_FILENAME` variables within the script if you wish to use a different dataset.

4.  **Outputs:**
    *   A new run-specific directory will be created under `NCAs/runs/` (e.g., `NCAs/runs/grun_YYMMDD_HHMMSS/`).
    *   **Submission File:** `submission.json` containing the predictions will be saved in this run directory.
    *   **Worker Script:** A temporary `temp_nca_worker.py` is created and used during the run in this directory.
    *   **Visualizations (PNGs):** If you are using the version of `gpu_prl_nca.py` modified to include visualizations, PNG images for each test case (input, prediction, and ground truth if available) will be saved under `NCAs/runs/<run_name>/visualizations/<task_id>/<test_case_idx>/`.

## Evaluating Results

The `NCAs/evaluate.py` script can be used to compare a generated `submission.json` file against ground truth solutions. It calculates various metrics and can generate a `visualization.pdf` file.

1.  **Ensure you are in the project root directory where the `venv` is.** The script uses paths relative to the project root.

2.  **Run the evaluation script with command-line arguments:**
    ```bash
    python3 NCAs/evaluate.py \
        --submission_file NCAs/runs/<run_name>/submission.json \
        --challenges_file dataset/script-tests/grouped-tasks/challenges.json \
        --solutions_file dataset/script-tests/grouped-tasks/solutions.json \
        --output_dir NCAs/runs/<run_name>/ \
        --visualize
    ```
    Replace `<run_name>` with the actual directory name of your experiment run (e.g., `grun_250609_070008`).

3.  **Arguments:**
    *   `--submission_file`: Path to the `submission.json` generated by the NCA script. (Required)
    *   `--challenges_file`: Path to the challenges JSON file used for the submission. (Required)
    *   `--solutions_file`: Path to the corresponding solutions JSON file. (Required)
    *   `--output_dir`: Directory where `results.csv` and `visualization.pdf` will be saved. This is typically the same as the run directory. (Required)
    *   `--visualize`: If specified, a `visualization.pdf` will be generated. (Optional)

4.  **Outputs (saved in the specified `--output_dir`):**
    *   `results.csv`: A CSV file with detailed performance metrics per task (fraction correct, pixel accuracy).
    *   `visualization.pdf`: (If `--visualize` is used) A PDF file showing the input, predicted attempts, and ground truth for each test case, sorted by performance.

## NCA Model Version Comparison

The NCA implementations have evolved across different versions (v1 to v5), primarily in their perception mechanisms, use of Layer Normalization, and loss functions. The `gpu_prl_nca.py` script structure within each version (which handles parallel execution) remains largely consistent. Here's a summary of the key differences in the core `CellularNN` model within these versions, based on their respective `gpu_prl_nca.py` files:

| Feature                 | `vanilla-v1`                                     | `vanilla-v2`                                       | `vanilla-v3`                                                                 | `vanilla-v4`                                     | `vanilla-v5`                                     |
| :---------------------- | :----------------------------------------------- | :------------------------------------------------- | :--------------------------------------------------------------------------- | :----------------------------------------------- | :----------------------------------------------- |
| **Primary Script**      | `gpu_prl_nca.py` (multiprocessing worker)        | `gpu_prl_nca.py` (multiprocessing worker)          | `gpu_prl_nca.py` (multiprocessing worker)                                    | `gpu_prl_nca.py` (multiprocessing worker)        | `gpu_prl_nca.py` (multiprocessing worker)        |
| **Neighbor Perception** | Color channels only                              | All channels (color + hidden)                      | All channels (color + hidden)                                                | All channels (color + hidden)                      | All channels (color + hidden)                      |
| `perception_channels`   | `self.in_channels + (8 * self.n_classes)`        | `self.in_channels + (8 * self.in_channels)`      | `self.in_channels + (8 * self.in_channels)`                                | `self.in_channels + (8 * self.in_channels)`      | `self.in_channels + (8 * self.in_channels)`      |
| **Layer Normalization** | Present                                          | Present                                            | Present                                                                      | Present                                          | **Absent**                                       |
| **Loss Function**       | Cross-Entropy on color channels                  | Cross-Entropy on color channels                    | **Composite:**<br/>- Cross-Entropy (color ch.)<br/>- MSE (hidden ch.)          | MSE on all channels (color + hidden)             | MSE on all channels (color + hidden)             |
| `create_array_from_grid` (Target for Loss) | One-hot color, zero hidden | One-hot color, zero hidden | One-hot color, zero hidden | One-hot color, zero hidden | One-hot color, zero hidden |

**Summary of Evolution:**

*   **v1:** Started with a basic NCA where neighbors only communicate their color state. Loss is based on correctly predicting the target colors.
*   **v2:** Enhanced neighbor perception to include all channels (colors and hidden/communication states). This allows richer information exchange between cells. Loss function remained focused on color prediction.
*   **v3:** Introduced a more complex loss function. While still predicting colors (Cross-Entropy), it added an MSE loss component to also guide the learning of the hidden/communication channels, presumably to encourage them to learn useful internal representations that match the (zeroed) hidden channels of the target.
*   **v4:** Simplified the loss to a single MSE term across all channels (both color and hidden). This directly tries to make the NCA's full state match the target's full state (one-hot colors, zeroed hidden channels).
*   **v5:** Built upon `v4` (MSE loss on all channels and full neighbor perception) by **removing Layer Normalization**. The `about.md` for v5 suggests this change was made because MSE loss was being applied to all channels.

## Further Details

The code for the core NCA model variations (`vanilla-v1` through `vanilla-v5`) can be found in their respective subdirectories under `NCAs/`. The original `vanilla-v1` folder contains the version that has been most actively developed in this context.